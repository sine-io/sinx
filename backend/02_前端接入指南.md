# 前端接入指南（认证、权限与菜单）

本文指导前端快速对接后端认证与 RBAC 菜单能力，包含请求示例与 UI 路由生成伪代码。

- 基础地址：`http://<host>:<port>`（本地默认 `http://localhost:8080`）
- 统一返回包裹：`{ code: number, message: string, data: any }`
- 鉴权方式：除开放接口外，请在请求头携带 `Authorization: Bearer <token>`

---

## 一、快速对接流程

1. 登录获取 token

   - POST `/api/auth/login`
   - 请求体：`{ username: string, password: string }`

   示例（curl）：

   ```bash
   curl -X POST http://localhost:8080/api/auth/login \
     -H "Content-Type: application/json" \
     -d '{"username":"john_doe","password":"password123"}'
   ```

   成功响应（节选）：

   ```json
   {
     "code": 0,
     "data": {
       "token": "<JWT>",
       "user": { "id": 1, "username": "john_doe", "email": "john@example.com", "is_active": true }
     }
   }
   ```

   将 `data.token` 缓存用于后续请求头。

1. 获取当前用户资料（推荐）

   - GET `/api/user/profile`（需登录）

   示例（curl）：

   ```bash
   curl -X GET http://localhost:8080/api/user/profile \
     -H "Authorization: Bearer <TOKEN>"
   ```

1. 获取用户菜单（用于动态路由/侧边栏）

   - GET `/api/user/menus[?userId=<id>]`（需登录）

   示例（curl）：

   ```bash
   curl -X GET http://localhost:8080/api/user/menus \
     -H "Authorization: Bearer <TOKEN>"
   ```

   响应中 `data` 为菜单树：`{ id, name, parentId, path?, component?, icon?, children[] }`。

1.（可选）获取用户角色与权限相关

- GET `/api/user/roles?id=<userId>`（需权限 `user:roles`）
- GET `/api/perms/all`（需要登录，返回系统所有权限点）

---

## 二、请求封装示例

以 Axios 为例配置鉴权头与失败处理（伪代码）：

```ts
import axios from 'axios';

export const api = axios.create({ baseURL: 'http://localhost:8080' });

api.interceptors.request.use((config) => {
  const token = localStorage.getItem('token');
  if (token) config.headers.Authorization = `Bearer ${token}`;
  return config;
});

api.interceptors.response.use(
  (res) => res.data,
  (err) => {
    if (err?.response?.status === 401) {
      // 未认证：跳转登录
      window.location.href = '/login';
    }
    return Promise.reject(err);
  }
);
```

---

## 三、UI 路由生成伪代码

后端菜单结构（简）

```ts
type MenuTreeNode = {
  id: number;
  name: string;
  parentId: number;
  path?: string;
  component?: string; // 如 "system/user/index" 或 "Layout"
  icon?: string;
  children: MenuTreeNode[];
};
```

从菜单树生成前端路由（以 Vue Router 为例，React 可用同样思想生成 RouteObject）：

```ts
// 根据后端的 component 值映射到真实组件
const componentMap: Record<string, any> = {
  Layout: () => import('@/layouts/Layout.vue'),
  'system/user/index': () => import('@/views/system/user/index.vue'),
  // ...按需补充
};

function mapComponent(name?: string) {
  if (!name) return undefined;
  return componentMap[name] ?? (() => import(`@/views/${name}.vue`));
}

// 递归构建 RouteRecordRaw 数组
function buildRoutesFromMenuTree(nodes: MenuTreeNode[]): any[] {
  return nodes.map((n) => {
    const route: any = {
      path: n.path || `/${n.id}`,
      name: n.name,
      component: mapComponent(n.component),
      meta: { icon: n.icon, id: n.id },
    };
    if (n.children?.length) route.children = buildRoutesFromMenuTree(n.children);
    return route;
  });
}

// 启动时拉取并注册动态路由
async function boot() {
  const login = await api.post('/api/auth/login', { username, password });
  localStorage.setItem('token', login.data.token);

  const profile = await api.get('/api/user/profile');
  // 可保存用户信息到状态管理

  const menus = await api.get('/api/user/menus');
  const dynamicRoutes = buildRoutesFromMenuTree(menus.data);
  // router.addRoute(...) 或在框架内批量注册
}
```

React Router 伪代码要点：将上面 route 对象适配为 `{ path, element, children }`，element 使用 `lazy(() => import(...))`。

---

## 四、常见错误与处理

- 401 未认证（`code=10003`）：未带 `Authorization` 或 token 过期 → 跳转登录并重新获取 token。
- 403 无权限（`code=10004`）：访问受权限保护接口 → 确认账号角色与菜单/权限点绑定完整。
- 菜单树为空：账号未分配角色或角色未绑定菜单 → 先在管理端完成角色与菜单的创建和绑定。

---

## 五、接口速查（与后端一致）

- 登录：POST `/api/auth/login`
- 用户资料：GET `/api/user/profile`
- 用户菜单：GET `/api/user/menus[?userId=<id>]`
- 用户角色（可选）：GET `/api/user/roles?id=<userId>`（需权限 `user:roles`）
- 全量权限点（可选）：GET `/api/perms/all`

字段参考：

- Role（简）：`{ id, name, remark, status }`
- MenuTreeNode：`{ id, name, parentId, path?, component?, icon?, children[] }`
